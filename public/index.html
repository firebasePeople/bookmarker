<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Booktracker</title>

</head>

<body>
    <h2>My booktracker</h2>
    <div id="readingDiv">
        <h4>Reading</h4>
        <p style="background-color:rgb(98, 226, 98)" class="notifyReading"></p>
        <span style="color:orange">Enter book ID in the format  ISBN:###### </span>
        <br />
        <input type="text" name="readingInput" id="readingInput" placeholder="add new book" />
        <input type="text" name="readingIsbn" id="readingIsbn" placeholder="add book's isbn" />
        <button id="readingBtn">Add</button>

        <ul id="readingUl">
            <li>reading</li>
        </ul>
    </div>
    <div id="toreadDiv">
        <h4>To read</h4>
        <p style="background-color:rgb(98, 226, 98)" class="notifyToRead"></p>
        <span style="color:orange">Enter book ID in the format  ISBN:###### </span>
        <br />
        <input type="text" name="toreadInput" id="toreadInput" placeholder="add new book" />
        <input type="text" name="toreadIsbn" id="toreadIsbn" placeholder="add book's isbn" />
        <button id="toreadBtn">Add</button>
        <ul id="toreadUl">
            <li>To read</li>
        </ul>
    </div>
    <div id="readDiv">
        <h4>Done reading</h4>
        <p style="background-color:rgb(98, 226, 98)" class="notifyRead"></p>

        <span style="color:orange">Enter book ID in the format  ISBN:###### </span>
        <br />
        <input type="text" name="readInput" id="readInput" placeholder="add new book" />
        <input type="text" name="readIsbn" id="readIsbn" placeholder="add book's isbn" />
        <button id="readBtn">Add</button>
        <ul id="readUl">
            <li>Done Reading</li>
        </ul>
    </div>

    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-app.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-auth.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-database.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-functions.js"></script> -->

    <script>
        var config = {
            apiKey: "AIzaSyACQuhx5EFgF-blK07IOMVxvnhs-_5EpuI",
            authDomain: "aptrack-energyhack.firebaseapp.com",
            databaseURL: "https://aptrack-energyhack.firebaseio.com",
            projectId: "aptrack-energyhack",
            storageBucket: "aptrack-energyhack.appspot.com",
            messagingSenderId: "12574207374"
        };
        firebase.initializeApp(config);
    </script>
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function(e) {
            // e.preventDefault();

            var dbRef = firebase.database();

            function insertIntoList(bookName, bookIsbn, UlIdParam) {
                // console.log(bookName + bookIsbn + UlIdParam);
                var liElement = document.createElement('li');
                var ulId = document.querySelector('#' + UlIdParam);
                liElement.innerHTML = '<span>Book Name :' + bookName + '</span> <br />' + '<span>ISBN : ' + bookIsbn + '</span> <br />';
                // liElement.id = bookName;
                ulId.insertBefore(liElement, ulId.childNodes[0]);
            };

            function inputClearFunction(inputFieldId) {
                var tempreadIP = document.getElementById(inputFieldId);
                tempreadIP.value = '';
            };

            function getDbData(collectionName) {
                var collRef = dbRef.ref().child(collectionName);
                // console.log(collRef.parent.name);
                collRef.once('value', function(snapshot) {
                    var bookList = snapshot.val();
                    // console.log(bookList);
                    for (var key in bookList) {
                        var bookname = snapshot.child(key).child("name").val();
                        var bookisbn = snapshot.child(key).child("isbn").val();
                        // console.log(bookname + bookisbn + 'getdbdata call');
                        insertIntoList(bookname, bookisbn, snapshot.key + 'Ul');
                    };

                });
            };

            //this function searches for books with same isbn in the db in all the three columns. If there is any, it is removed from that column.
            function removeInconsistency(bookIsbn) {
                var readingRef = dbRef.ref("reading/");
                var toreadRef = dbRef.ref("toread/");
                var readRef = dbRef.ref("read/");

                const query = readingRef.orderByChild('isbn').equalTo(bookIsbn);

                query.on("value", snapshot => {
                    console.log(snapshot.val());
                    // if (snapshot.exists() {

                    //     });
                });
            };


            var readingBtn = document.querySelector('#readingBtn');
            var toreadBtn = document.querySelector('#toreadBtn');
            var readBtn = document.querySelector('#readBtn');

            readingBtn.addEventListener('click', function() {
                var readingField = document.querySelector('#readingInput').value;
                var readingIsbn = document.querySelector('#readingIsbn').value;
                dbRef.ref().child(readingIsbn).set({
                    name: readingField,
                    category: "reading"
                }).then(function() {
                    insertIntoList(readingField, readingIsbn, "readingUl");
                    inputClearFunction("readingInput");
                    inputClearFunction("readingIsbn");
                    document.getElementById("notifyReading").innerHTML = "Congrats! The book has been added to the list. If the book was already in this category, its not added.!";
                    // removeInconsistency(readingIsbn);
                }).catch(function(error) {
                    console.log(error);
                    window.alert('error adding book to the list');
                });
            });

            toreadBtn.addEventListener('click', function() {
                var toreadField = document.querySelector('#toreadInput').value;
                var toreadIsbn = document.querySelector('#toreadIsbn').value;
                dbRef.ref().child(toreadIsbn).set({
                    name: toreadField,
                    category: "toread"
                }).then(function() {
                    // console.log('success!book added successfully');
                    insertIntoList(toreadField, toreadIsbn, "toreadUl");
                    inputClearFunction("toreadInput");
                    inputClearFunction("toreadIsbn");
                    document.getElementById("notifyToRead").innerHTML = "Congrats! The book has been added to the list. If the book was already in this category, its not added.!";
                    // removeInconsistency(toreadIsbn);
                }).catch(function(error) {
                    window.alert('error adding book to the list');
                });
            });

            readBtn.addEventListener('click', function() {
                var readField = document.querySelector('#readInput').value;
                var readIsbn = document.querySelector('#readIsbn').value;
                dbRef.ref().child(readIsbn).set({
                    name: readField,
                    category: "read"
                }).then(function() {
                    insertIntoList(readField, readIsbn, "readUl");
                    inputClearFunction("readInput");
                    inputClearFunction("readIsbn");
                    document.getElementById("notifyRead").innerHTML = "Congrats! The book has been added to the list. If the book was already in this category, its not added.!";
                    // removeInconsistency(readIsbn);
                }).catch(function(error) {
                    window.alert('error adding book to the list');
                });
            });

            getDbData('reading');
            getDbData('toread');
            getDbData('read');

        });
    </script>
</body>

</html>